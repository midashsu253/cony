<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>å®¢æˆ¶ç®¡ç†ï¼ˆå«å°æœ‹å‹åå­— + åŒ¯å…¥/åŒ¯å‡ºï¼‰</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="manifest" href="">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="å¯æ„›å…”å…”" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter','Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        html, body { height: 100%; overflow: hidden; }
        #app-screen { height: 100vh; display:flex; flex-direction:column; }
        #main-content { flex-grow:1; overflow-y:auto; }
        .customer-card.dragging { opacity:0.5; border:2px dashed #9ca3af; }
        #trash-bin.drag-over { transform:scale(1.05); background-color:#fecaca; }
        .modal { transition: opacity .2s ease-in-out, visibility .2s ease-in-out; }
        .modal-content { transition: transform .2s ease-in-out; }
        .modal.hidden .modal-content { transform: scale(0.98); }
        [contenteditable="true"] { border:1px solid #d1d5db; border-radius:.375rem; padding:.5rem .75rem; min-height:100px; background-color:#fff; }
        [contenteditable="true"]:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 2px #c7d2fe; }
    </style>

  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="pwa-icon.png">
</head>
<body class="bg-gray-100 antialiased overflow-hidden">

<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <symbol id="icon-plus" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
  <symbol id="icon-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"/><line x1="21" y1="21" x2="16" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="icon-export" viewBox="0 0 24 24"><path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="icon-import" viewBox="0 0 24 24"><path d="M12 21V9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M16 17l-4 4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  <symbol id="icon-restore" viewBox="0 0 24 24"><path d="M3 12v-2a4 4 0 0 1 4-4h13" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
  <symbol id="icon-camera" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="1.5" fill="none"/><circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="1.5" fill="none"/></symbol>
</svg>

<div id="login-screen" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
    <h2 id="login-title" class="text-2xl font-bold text-center text-gray-800 mb-4">æ­¡è¿ä½¿ç”¨</h2>
    <form id="login-form">
      <p id="login-message" class="text-center text-gray-600 mb-4">è«‹è¨­å®šæ‚¨çš„ 6 ä½æ•¸å¯†ç¢¼</p>
      <input type="password" id="password-input" inputmode="numeric" pattern="[0-9]*" maxlength="6" class="w-full px-4 py-3 text-center text-2xl tracking-[.5em] border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" required>
      <input type="password" id="password-confirm" inputmode="numeric" pattern="[0-9]*" maxlength="6" class="w-full px-4 py-3 mt-3 text-center text-2xl tracking-[.5em] border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" placeholder="è«‹å†æ¬¡ç¢ºèª">
      <button type="submit" id="login-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition duration-200">è¨­å®šå¯†ç¢¼</button>
    </form>
    <p id="login-error" class="text-red-500 text-center mt-3 hidden"></p>
  </div>
</div>

<div id="app-screen" class="hidden">
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-bold text-indigo-700">å¯æ„›å…”å…”</h1>
      <div class="flex items-center space-x-2">
        <button id="add-customer-btn" class="p-2 rounded-full text-indigo-600 hover:bg-indigo-100 transition" title="æ–°å¢å®¢æˆ¶">
          <svg class="w-6 h-6"><use href="#icon-plus"></use></svg>
        </button>
        <div class="ml-2 flex items-center gap-2">
          <input type="number" min="0" id="global-reminder-months" placeholder="æœˆæ•¸" class="w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
          <button id="save-reminder-months" type="button" class="px-3 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 text-sm">å„²å­˜</button>
        </div>


        <button id="export-btn" class="p-2 rounded-full text-green-600 hover:bg-green-100 transition" title="åŒ¯å‡º JSON">
          <svg class="w-6 h-6"><use href="#icon-export"></use></svg>
        </button>

        <label for="import-input" id="import-btn" class="p-2 rounded-full text-blue-600 hover:bg-blue-100 transition cursor-pointer" title="åŒ¯å…¥ JSON">
          <svg class="w-6 h-6"><use href="#icon-import"></use></svg>
        </label>
        <input type="file" id="import-input" accept="application/json" class="hidden" />
        
        <button id="open-trash-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 transition relative" title="åƒåœ¾æ¡¶">
          <svg class="w-6 h-6"><use href="#icon-trash"></use></svg>
          <span id="trash-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden"></span>
        </button>
      </div>
    </div>

    <div class="px-4 pb-3">
      <div class="relative">
        <input type="search" id="search-bar" placeholder="æœå°‹å§“åã€é›»è©±ã€åœ°å€..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-transparent">
        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
          <svg class="w-5 h-5"><use href="#icon-search"></use></svg>
        </div>
      </div>

      <div class="px-4 pb-3 pt-3">
        <label for="card-density" class="flex items-center justify-between text-sm text-gray-600 mb-1">
          <span>å¡ç‰‡å¯†åº¦ï¼ˆæ¯åˆ—å¡ç‰‡æ•¸ï¼‰</span>
          <span><span id="card-density-value" class="font-semibold text-indigo-600">4</span> / 10</span>
        </label>
        <input id="card-density" type="range" min="1" max="10" step="1" value="4" class="w-full accent-indigo-600">
      </div>
    </div>
  </header>

  <main id="main-content" class="flex-grow p-4">
    <div id="customer-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
    <p id="no-customers" class="text-center text-gray-500 mt-10 hidden">ç›®å‰æ²’æœ‰å®¢æˆ¶è³‡æ–™ã€‚<br>è«‹é»æ“Šå³ä¸Šè§’çš„ [+] æ–°å¢ã€‚</p>
  </main>

  <footer id="trash-bin" class="bg-red-100 border-t-2 border-red-300 p-6 text-center text-red-700 fixed bottom-0 left-0 right-0 z-20 transition-all duration-300 transform translate-y-full">
    <svg class="w-8 h-8 mx-auto"><use href="#icon-trash"></use></svg>
    <p class="font-semibold mt-1">æ‹–æ›³åˆ°æ­¤è™•åˆªé™¤</p>
  </footer>
</div>

<div id="customer-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden" onclick="hideModal('customer-modal')">
  <div class="modal-content bg-gray-50 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
    <form id="customer-form" class="p-6 space-y-4">
      <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4">æ–°å¢å®¢æˆ¶</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700">åå­—*</label>
          <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
        <div>
          <label for="phone" class="block text-sm font-medium text-gray-700">é›»è©±* (ä¸»è¦ç´¢å¼•)</label>
          <input type="tel" id="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
        </div>
      </div>

      <div>
        <label for="child-name" class="block text-sm font-medium text-gray-700">å°æœ‹å‹åå­—</label>
        <input type="text" id="child-name" placeholder="ä¾‹å¦‚ï¼šå°æ˜" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="dob" class="block text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥</label>
          <input type="text" id="dob" placeholder="ä¾‹å¦‚: 1990/05/20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
      </div>
      <div>
        <label for="address" class="block text-sm font-medium text-gray-700">åœ°å€</label>
        <input type="text" id="address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
      </div>


      <div>
        <label class="block text-sm font-medium text-gray-700">è¨‚é–±ç‰ˆæœ¬</label>
        <div class="mt-2 grid grid-cols-3 gap-3">
          <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-300 bg-white cursor-pointer">
            <input type="checkbox" id="ver-60107" value="60107" class="form-version rounded text-indigo-600">
            <span style="color:#6d5f3b">å­¸å‰ç‰ˆ (ç±³)</span>
          </label>
          <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-300 bg-white cursor-pointer">
            <input type="checkbox" id="ver-60108" value="60108" class="form-version rounded text-indigo-600">
            <span style="color:#166534">åˆéšç‰ˆ (ç¶ )</span>
          </label>
          <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-300 bg-white cursor-pointer">
            <input type="checkbox" id="ver-60109" value="60109" class="form-version rounded text-indigo-600">
            <span style="color:#5b21b6">é€²éšç‰ˆ (ç´«)</span>
          </label>
        </div>
      </div>

      <div class="bg-gray-100 p-4 rounded-lg border border-gray-200">
        <h3 class="text-lg font-medium text-gray-800 mb-3">è¨‚é–±æ–¹æ¡ˆ</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="start-issue-version" class="block text-sm font-medium text-gray-700">é–‹å§‹ç‰ˆæœ¬</label>
            <select id="start-issue-version" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              <option value="">è«‹é¸æ“‡</option>
              <option value="60107">å­¸å‰ç‰ˆ (60107)</option>
              <option value="60108">åˆéšç‰ˆ (60108)</option>
              <option value="60109">é€²éšç‰ˆ (60109)</option>
            </select>
          </div>
          <div>
            <label for="start-issue" class="block text-sm font-medium text-gray-700">é–‹å§‹æœŸæ•¸</label>
            <input type="number" id="start-issue" placeholder="ä¾‹å¦‚: 154" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
        </div>

        <div class="mt-4">
          <label for="expiry-issue" class="block text-sm font-medium text-gray-700">åˆ°æœŸæœŸæ•¸</label>
          <input type="number" id="expiry-issue" placeholder="ä¾‹å¦‚: 168" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>

        <div class="mt-4 p-3 bg-white rounded-md border border-gray-300">
          <p class="text-sm font-medium text-gray-700">é è¨ˆåˆ°æœŸæ—¥:</p>
          <p id="expiry-date-display" class="text-lg font-bold text-indigo-700">-</p>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨» (å¯æ‹ç…§æˆ–æ‰‹å¯«è½‰æ–‡å­—)</label>
        <div class="flex items-center space-x-2 mb-2">
          <button type="button" id="ocr-camera-btn" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            <svg class="w-5 h-5 mr-2"><use href="#icon-camera"></use></svg> æ‹ç…§/ä¸Šå‚³
          </button>
          <input type="file" id="ocr-file-input" accept="image/*" class="hidden">
          <button type="button" id="ocr-handwriting-btn" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            (æ‰‹å¯«åŠŸèƒ½é–‹ç™¼ä¸­)
          </button>
        </div>
        <p id="ocr-status" class="text-sm text-indigo-600 text-center hidden"></p>
      </div>

      <div id="highlight-toolbar" class="bg-gray-200 p-1 rounded-md flex space-x-1 hidden">
        <button type="button" data-color="#fef08a" class="highlight-btn w-6 h-6 rounded bg-yellow-200 border border-yellow-300"></button>
        <button type="button" data-color="#bbf7d0" class="highlight-btn w-6 h-6 rounded bg-green-200 border border-green-300"></button>
        <button type="button" data-color="#bfdbfe" class="highlight-btn w-6 h-6 rounded bg-blue-200 border border-blue-300"></button>
        <button type="button" data-color="#fbcfe8" class="highlight-btn w-6 h-6 rounded bg-pink-200 border border-pink-300"></button>
        <button type="button" data-color="transparent" class="highlight-btn w-6 h-6 rounded bg-white border border-gray-300 text-xs">æ¸…é™¤</button>
      </div>

      <div id="notes" contenteditable="true" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="é»æ­¤è¼¸å…¥å‚™è¨»..."></div>

      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" class="px-4 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300" onclick="hideModal('customer-modal')">å–æ¶ˆ</button>
        <button type="submit" class="px-4 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">å„²å­˜</button>
      </div>
    </form>

    <div id="call-log-section" class="p-6 pt-0 hidden">
      <div class="flex justify-between items-center mt-4 mb-3">
        <h3 class="text-lg font-medium text-gray-800">é€šè©±è¨˜éŒ„</h3>
        <button type="button" id="add-call-log-btn" class="px-3 py-1 text-sm rounded-md text-white bg-green-600 hover:bg-green-700">æ–°å¢è¨˜éŒ„</button>
      </div>
      <div id="call-log-list" class="space-y-3 max-h-48 overflow-y-auto bg-gray-100 p-3 rounded-md border">
        <p id="no-call-logs" class="text-gray-500 text-center">å°šç„¡é€šè©±è¨˜éŒ„</p>
      </div>
    </div>
  </div>
</div>

<div id="trash-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden" onclick="hideModal('trash-modal')">
  <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md max-h-[70vh] flex flex-col" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold text-gray-800">åƒåœ¾æ¡¶</h2>
      <button class="p-1 rounded-full hover:bg-gray-200" onclick="hideModal('trash-modal')"><svg class="w-6 h-6"><use href="#icon-restore"></use></svg></button>
    </div>
    <div id="trash-list" class="flex-grow overflow-y-auto p-4 space-y-3"></div>
    <p id="no-trash" class="text-center text-gray-500 p-10 hidden">åƒåœ¾æ¡¶æ˜¯ç©ºçš„</p>
  </div>
</div>

<div id="undo-bar" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-5 py-3 rounded-lg shadow-lg flex items-center justify-between transition-all duration-300 transform translate-y-20 opacity-0 z-50">
  <p id="undo-message" class="mr-4">å·²å°‡å®¢æˆ¶ç§»è‡³åƒåœ¾æ¡¶</p>
  <button id="undo-btn" class="font-bold text-indigo-400 hover:text-indigo-300">å¾©åŸ</button>
</div>

<div id="alert-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden" onclick="hideModal('alert-modal')">
  <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm" onclick="event.stopPropagation()">
    <div class="p-6 text-center">
      <div class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center mx-auto mb-4">
        <svg class="w-7 h-7"><use href="#icon-restore"></use></svg>
      </div>
      <h3 id="alert-title" class="text-lg font-medium text-gray-900 mb-2">æé†’</h3>
      <p id="alert-message" class="text-sm text-gray-600 mb-6">è¨Šæ¯</p>
      <button class="w-full px-4 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700" onclick="hideModal('alert-modal')">ç¢ºå®š</button>
    </div>
  </div>
</div>

<div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div class="bg-white rounded-lg p-6 flex items-center space-x-4">
    <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
    <span class="text-gray-700">AI è®€å–ä¸­...</span>
  </div>
</div>

<div id="call-log-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden" onclick="hideModal('call-log-modal')">
  <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md" onclick="event.stopPropagation()">
    <form id="call-log-form" class="p-6 space-y-4">
      <h2 class="text-xl font-bold text-gray-800 mb-4">æ–°å¢é€šè©±è¨˜éŒ„</h2>
      <div>
        <label for="call-log-date" class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
        <input type="date" id="call-log-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
      </div>
      <div>
        <label for="call-log-follow-up" class="block text-sm font-medium text-gray-700">ä¸‹æ¬¡è¿½è¹¤æ™‚é–“ (å¯é¸)</label>
        <input type="date" id="call-log-follow-up" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
      </div>
      <div>
        <label for="call-log-notes" class="block text-sm font-medium text-gray-700">å‚™è¨»</label>
        <textarea id="call-log-notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
      </div>
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" class="px-4 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300" onclick="hideModal('call-log-modal')">å–æ¶ˆ</button>
        <button type="submit" class="px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700">å„²å­˜è¨˜éŒ„</button>
      </div>
    </form>
  </div>
</div>

<div id="follow-up-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden" onclick="hideModal('follow-up-modal')">
  <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md" onclick="event.stopPropagation()">
    <div class="p-6">
      <div class="flex items-center space-x-3 mb-4">
        <div class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0">
          <svg class="w-7 h-7"><use href="#icon-restore"></use></svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900">ä»Šæ—¥è¿½è¹¤æé†’</h3>
      </div>
      <div id="follow-up-list" class="text-sm text-gray-600 mb-6 max-h-60 overflow-y-auto space-y-2"></div>
      <button class="w-full px-4 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700" onclick="hideModal('follow-up-modal')">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>
</div>

<script type="module">
/* ====================
   State & constants
   ==================== */
let customers = [];
let trashedCustomers = [];
let currentPassword = null;
let loggedIn = false;
let draggedElement = null;
let editingCustomerId = null;
let lastDeletedCustomer = null;
let undoTimeout = null;

const BASE_ISSUES = { '60107': 154, '60108': 549, '60109': 534 };
const BASE_DATES = {
  '60107': new Date('2025-10-01T00:00:00Z'),
  '60108': new Date('2025-10-01T00:00:00Z'),
  '60109': new Date('2025-10-01T00:00:00Z')
};
const VERSION_COLORS = { '60107': '#FFFBEB', '60108': '#F0FDF4', '60109': '#F5F3FF' };

/* ====================
   DOM shortcuts
   ==================== */
const $ = (s) => document.querySelector(s);

const loginScreen = $('#login-screen');
const appScreen = $('#app-screen');
const loginForm = $('#login-form');
const passwordInput = $('#password-input');
const passwordConfirm = $('#password-confirm');
const loginMessage = $('#login-message');
const loginTitle = $('#login-title');
const loginButton = $('#login-button');
const loginError = $('#login-error');

const customerGrid = $('#customer-grid');
const noCustomersMsg = $('#no-customers');
const searchBar = $('#search-bar');

const trashBin = $('#trash-bin');
const openTrashBtn = $('#open-trash-btn');
const trashCount = $('#trash-count');

const customerModal = $('#customer-modal');
const modalTitle = $('#modal-title');
const customerForm = $('#customer-form');

const undoBar = $('#undo-bar');
const undoBtn = $('#undo-btn');
const undoMessage = $('#undo-message');

const notesEditor = $('#notes');
const highlightToolbar = $('#highlight-toolbar');

const ocrFileInput = $('#ocr-file-input');
const ocrStatus = $('#ocr-status');
const loadingOverlay = $('#loading-overlay');

const callLogSection = $('#call-log-section');
const addCallLogBtn = $('#add-call-log-btn');
const callLogList = $('#call-log-list');
const noCallLogs = $('#no-call-logs');
const callLogForm = $('#call-log-form');

const cardDensity = $('#card-density');
const cardDensityValue = $('#card-density-value');

const importInput = $('#import-input');
const exportBtn = $('#export-btn');

/* ====================
   PWA manifest & SW
   ==================== */
function generateManifestDataUri() {
  const manifest = {
    name: "å®¢æˆ¶è³‡æ–™ç®¡ç†",
    short_name: "å®¢æˆ¶ç®¡ç†",
    start_url: location.pathname,
    display: "standalone",
    background_color: "#f3f4f6",
    theme_color: "#4f46e5",
    icons: [
      { src: "https://placehold.co/192x192/4f46e5/FFFFFF?text=CRM", type: "image/png", sizes: "192x192" },
      { src: "https://placehold.co/512x512/4f46e5/FFFFFF?text=CRM", type: "image/png", sizes: "512x512" }
    ]
  };
  try {
    const manifestString = JSON.stringify(manifest);
    const manifestBase64 = btoa(unescape(encodeURIComponent(manifestString)));
    const dataUri = `data:application/json;base64,${manifestBase64}`;
    document.querySelector('link[rel="manifest"]').setAttribute('href', dataUri);
  } catch (e) {
    console.error("å»ºç«‹ manifest å¤±æ•—:", e);
  }
}

function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    const swCode = `
      const CACHE_NAME = 'crm-pwa-cache-v1';
      const urlsToCache = ['${location.pathname}', 'https://cdn.tailwindcss.com'];
      self.addEventListener('install', event => event.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache))));
      self.addEventListener('fetch', event => event.respondWith(caches.match(event.request).then(r => r || fetch(event.request))));
    `;
    try {
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).then(() => console.log('SW registered')).catch(e => console.warn('SW fail', e));
    } catch (e) {
      console.error('registerServiceWorker error', e);
    }
  }
}

/* ====================
   Modal / Alerts
   ==================== */
window.showModal = (modalId) => {
  const m = $(`#${modalId}`);
  if (m) { m.classList.remove('hidden'); m.classList.add('flex'); setTimeout(() => m.classList.add('opacity-100'), 10); }
};
window.hideModal = (modalId) => {
  const m = $(`#${modalId}`);
  if (m) { m.classList.remove('opacity-100'); setTimeout(() => { m.classList.add('hidden'); m.classList.remove('flex'); }, 200); }
};
window.showAlert = (message, title = 'æé†’') => {
  $('#alert-title').textContent = title;
  $('#alert-message').textContent = message;
  showModal('alert-modal');
};

/* ====================
   Auth
   ==================== */
function initAuth() {
  currentPassword = localStorage.getItem('crm_password');
  if (currentPassword) {
    loginTitle.textContent = 'è«‹ç™»å…¥';
    loginMessage.textContent = 'è«‹è¼¸å…¥æ‚¨çš„ 6 ä½æ•¸å¯†ç¢¼';
    passwordConfirm.classList.add('hidden');
    loginButton.textContent = 'ç™»å…¥';
  } else {
    loginTitle.textContent = 'è¨­å®šå¯†ç¢¼';
    loginMessage.textContent = 'è«‹è¨­å®šæ‚¨çš„ 6 ä½æ•¸å¯†ç¢¼';
    passwordConfirm.classList.remove('hidden');
    loginButton.textContent = 'è¨­å®šå¯†ç¢¼';
  }
  loginError.classList.add('hidden');
  passwordInput.focus();
}

function handleLoginSubmit(e) {
  e.preventDefault();
  loginError.classList.add('hidden');
  const pass = passwordInput.value;
  if (currentPassword) {
    if (pass === currentPassword) {
      loggedIn = true;
      loginScreen.classList.add('hidden');
      appScreen.classList.remove('hidden');
      loadData();
    } else {
      loginError.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚';
      loginError.classList.remove('hidden');
      passwordInput.value = '';
    }
  } else {
    const confirmPass = passwordConfirm.value;
    if (pass.length !== 6) { loginError.textContent = 'å¯†ç¢¼å¿…é ˆç‚º 6 ä½æ•¸å­—ã€‚'; loginError.classList.remove('hidden'); return; }
    if (pass !== confirmPass) { loginError.textContent = 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ã€‚'; loginError.classList.remove('hidden'); return; }
    localStorage.setItem('crm_password', pass);
    currentPassword = pass;
    loggedIn = true;
    loginScreen.classList.add('hidden');
    appScreen.classList.remove('hidden');
    loadData();
  }
}

/* ====================
   Persist / Load
   ==================== */
function saveData() {
  if (!loggedIn) return;
  try {
    localStorage.setItem('crm_customers_order', JSON.stringify(customers));
    localStorage.setItem('crm_trashed_customers', JSON.stringify(trashedCustomers));
  } catch (e) {
    console.error('saveData error', e);
    showAlert('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œæ‚¨çš„è®Šæ›´å¯èƒ½ç„¡æ³•ä¿ç•™ã€‚', 'å„²å­˜å¤±æ•—');
  }
}

function loadData() {
  if (!loggedIn) return;
  try {
    customers = JSON.parse(localStorage.getItem('crm_customers_order')) || [];
    trashedCustomers = JSON.parse(localStorage.getItem('crm_trashed_customers')) || [];
  } catch (e) {
    console.error('loadData error', e);
    customers = []; trashedCustomers = [];
  }
  renderCustomers();
  updateTrashCount();
  checkFollowUps();
}

/* ====================
   Issue helpers
   ==================== */
function getIssueFromDate(version, targetDate) {
  const baseDate = BASE_DATES[version];
  const baseIssue = BASE_ISSUES[version];
  const diffMonths = (targetDate.getFullYear() - baseDate.getFullYear()) * 12 + (targetDate.getMonth() - baseDate.getMonth());
  if (version === '60107') return baseIssue + diffMonths;
  if (version === '60108' || version === '60109') {
    let issuesFromMonths = diffMonths * 2;
    let dayAdjustment = (targetDate.getDate() >= 15) ? 1 : 0;
    if (targetDate.getDate() === 1) dayAdjustment = 0;
    return baseIssue + issuesFromMonths + dayAdjustment;
  }
  return 0;
}

function getDateFromIssue(version, issueNum) {
  const baseDate = new Date(BASE_DATES[version].getTime());
  const baseIssue = BASE_ISSUES[version];
  const diffIssues = issueNum - baseIssue;
  if (version === '60107') {
    baseDate.setMonth(baseDate.getMonth() + diffIssues);
    baseDate.setDate(1);
    return baseDate;
  } else if (version === '60108' || version === '60109') {
    const monthsToAdd = Math.floor(diffIssues / 2);
    const day = (diffIssues % 2 === 0) ? 1 : 15;
    baseDate.setMonth(baseDate.getMonth() + monthsToAdd);
    baseDate.setDate(day);
    return baseDate;
  }
  return new Date();
}

function calculateExpiryDate() {
  const version = $('#start-issue-version').value;
  const issue = parseInt($('#start-issue').value, 10);
  // ç§»é™¤: const years = parseFloat($('#subscription-years').value);
  const expiryIssue = document.querySelector('#expiry-issue') ? Number(document.querySelector('#expiry-issue').value) : null;

  let displayDate = '-';
  let calculatedExpiryDate = null;
  
  if (version && expiryIssue != null && Number.isFinite(expiryIssue)) {
    // å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„åˆ°æœŸæœŸæ•¸è¨ˆç®—
    try {
      calculatedExpiryDate = getDateFromIssue(version, expiryIssue);
    } catch(e) {
      console.error('calculateExpiryDate error using expiryIssue', e);
    }
  // ç§»é™¤è¨‚é–±å¹´æ•¸çš„è¨ˆç®—é‚è¼¯
  /* } else if (version && Number.isFinite(issue) && Number.isFinite(years) && years > 0) {
    // å…¶æ¬¡ä½¿ç”¨é–‹å§‹æœŸæ•¸ + è¨‚é–±å¹´æ•¸è¨ˆç®— (ä¿ç•™åŸæœ‰é‚è¼¯ï¼Œä½†å»ºè­°ä¸»è¦ä½¿ç”¨ expiryIssue)
    try {
      const startDate = getDateFromIssue(version, issue);
      calculatedExpiryDate = new Date(startDate.getTime());
      calculatedExpiryDate.setMonth(calculatedExpiryDate.getMonth() + (years * 12));
    } catch(e) {
      console.error('calculateExpiryDate error using subscriptionYears', e);
    } */
  }
  
  if (calculatedExpiryDate) {
    const yyyy = calculatedExpiryDate.getFullYear();
    const mm = String(calculatedExpiryDate.getMonth() + 1).padStart(2,'0');
    const dd = String(calculatedExpiryDate.getDate()).padStart(2,'0');
    displayDate = `${yyyy}/${mm}/${dd}`;
  }
  
  $('#expiry-date-display').textContent = displayDate;
  return calculatedExpiryDate;
}

function isExpiryWarning(expiryDate) {
  if (!expiryDate) return false;
  const now = new Date();
  const fiveMonthsFromNow = new Date();
  fiveMonthsFromNow.setMonth(now.getMonth() + 5);
  return expiryDate <= fiveMonthsFromNow && expiryDate > now;
}

/* ====================
   Follow-ups & Call Logs
   ==================== */
function checkFollowUps() {
  const today = new Date().toISOString().split('T')[0];
  let reminders = [];
  customers.forEach(customer => {
    if (customer.callLogs && customer.callLogs.length) {
      customer.callLogs.forEach(log => {
        if (log.followUp === today) reminders.push({ name: customer.name, notes: log.notes });
      });
    }
  });
  if (reminders.length) {
    const followUpList = $('#follow-up-list');
    followUpList.innerHTML = '';
    reminders.forEach(r => {
      const item = document.createElement('div');
      item.className = 'p-3 bg-gray-50 rounded-md border';
      item.innerHTML = `<p class="font-semibold text-gray-800">${r.name}</p><p class="text-gray-600 whitespace-pre-wrap">${r.notes || 'ç„¡å‚™è¨»'}</p>`;
      followUpList.appendChild(item);
    });
    showModal('follow-up-modal');
  }
}

// æ ¹æ“šã€Œåˆ°æœŸæœŸæ•¸ã€èˆ‡ã€Œä»Šå¤©ã€æ›ç®—å‰©é¤˜æœŸæ•¸ï¼ˆä¾ç‰ˆåˆ¥ï¼‰
// - 60107ï¼šæ¯æœˆ 1 æœŸï¼ˆ1 è™Ÿï¼‰
// - 60108 / 60109ï¼šæ¯æœˆ 2 æœŸï¼ˆ1 è™Ÿã€15 è™Ÿï¼‰
// å›å‚³ null è¡¨ç¤ºç„¡æ³•è¨ˆç®—ï¼›å¦å‰‡å›å‚³ >=0 çš„æ•´æ•¸æœŸæ•¸
function getRemainingIssues(version, expiryIssue, refDate = new Date()) {
  if (!version || !Number.isFinite(Number(expiryIssue))) return null;
  try {
    const currentIssue = getIssueFromDate(version, refDate);
    return Math.max(0, Number(expiryIssue) - currentIssue);
  } catch(e) {
    console.warn('getRemainingIssues error', e);
    return null;
  }
}


function renderCallLogs(logs) {
  callLogList.innerHTML = '';
  if (!logs || logs.length === 0) {
    callLogList.appendChild(noCallLogs);
    noCallLogs.classList.remove('hidden');
  } else {
    noCallLogs.classList.add('hidden');
    const sortedLogs = [...logs].sort((a,b)=> new Date(b.date) - new Date(a.date));
    sortedLogs.forEach(log => {
      const item = document.createElement('div');
      item.className = 'p-3 bg-white rounded-md border shadow-sm';
      item.innerHTML = `
        <div class="flex justify-between items-center mb-1">
          <span class="font-medium text-gray-800">${log.date}</span>
          ${log.followUp ? `<span class="text-xs font-semibold text-indigo-600 bg-indigo-100 px-2 py-0.5 rounded-full">è¿½è¹¤: ${log.followUp}</span>` : ''}
        </div>
        <p class="text-sm text-gray-700 whitespace-pre-wrap">${log.notes || 'ç„¡å‚™è¨»'}</p>
      `;
      callLogList.appendChild(item);
    });
  }
}

/* ====================
   Card rendering
   ==================== */
function getCardBackground(versions) {
  const activeColors = (versions || []).map(v => VERSION_COLORS[v]).filter(Boolean);
  if (activeColors.length === 0) return 'background-color: #ffffff;';
  if (activeColors.length === 1) return `background-color: ${activeColors[0]};`;
  if (activeColors.length === 2) return `background: linear-gradient(90deg, ${activeColors[0]} 50%, ${activeColors[1]} 50%);`;
  if (activeColors.length === 3) return `background: linear-gradient(90deg, ${activeColors[0]} 33.3%, ${activeColors[1]} 33.3% 66.6%, ${activeColors[2]} 66.6%);`;
  return 'background-color: #ffffff;';
}

function renderCustomers() {
  if (!loggedIn) return;
  customerGrid.innerHTML = '';
  const filterText = (searchBar.value || '').toLowerCase();
  const filteredCustomers = customers.filter(c => {
    // ç§»é™¤ customerId åœ¨æœå°‹ç¯„åœå…§çš„æª¢æŸ¥
    const allData = [c.name, c.childName, c.phone, c.address, c.dob, c.notes].join(' ').toLowerCase();
    return allData.includes(filterText);
  });
  if (filteredCustomers.length === 0) {
    noCustomersMsg.classList.remove('hidden');
  } else {
    noCustomersMsg.classList.add('hidden');
    filteredCustomers.forEach(customer => customerGrid.appendChild(createCustomerCard(customer)));
  }
  addDragDropListeners();
}

function createCustomerCard(customer) {
  const card = document.createElement('div');
  card.className = 'customer-card p-4 rounded-lg shadow-md cursor-move transition-all duration-200';
  card.setAttribute('draggable', true);
  card.dataset.id = customer.id;
  card.setAttribute('style', getCardBackground(customer.versions || []));

  // **********************************************
  // ä¿®æ­£å¾Œçš„é‚è¼¯ï¼šåªä¾è³´ expiryIssue ä¾†è¨ˆç®— expiryDate
  // **********************************************
  let expiryDate = null;
  if (customer.startIssueVersion && customer.expiryIssue != null && Number.isFinite(Number(customer.expiryIssue))) {
      try {
          expiryDate = getDateFromIssue(customer.startIssueVersion, Number(customer.expiryIssue));
      } catch (e) {
          console.error('Error calculating card expiry date from expiryIssue:', e);
          expiryDate = null;
      }
  }
  // **********************************************

  let warningHtml = '';
  const in5MonthsWindow = expiryDate && isExpiryWarning(expiryDate);
  let remainingIssueBadge = '';
  if (in5MonthsWindow && customer.startIssueVersion && Number.isFinite(Number(customer.expiryIssue))) {
    const remain = getRemainingIssues(customer.startIssueVersion, Number(customer.expiryIssue), new Date());
    if (remain != null && remain > 0) {
      remainingIssueBadge = `<span class="block text-[12px] font-bold text-orange-700 bg-orange-100 px-2 py-1 rounded-full mb-2">å‰©é¤˜ ${remain} æœŸ</span>`;
    }
  }

  if (expiryDate && isExpiryWarning(expiryDate)) {
    warningHtml = `<span class="block text-sm font-bold text-pink-600 bg-pink-100 px-2 py-1 rounded-full mb-2">å³å°‡åˆ°æœŸ</span>`;
    card.classList.add('border-2','border-pink-500','ring-2','ring-pink-200');
  }

  const childHtml = customer.childName ? ` <span class="text-indigo-600">ğŸ‘¶ ${escapeHtml(customer.childName)}</span>` : '';
  card.innerHTML = `
    ${warningHtml}
    ${remainingIssueBadge}
    <h3 class="text-lg font-bold text-gray-800 truncate">${escapeHtml(customer.name)}${childHtml}</h3>
    <p class="text-sm text-gray-600 mt-1 truncate">${escapeHtml(customer.phone || '')}</p>
    <p class="text-xs text-gray-500 mt-1 truncate">${escapeHtml(customer.address || '') || '&nbsp;'}</p>
  `;

  card.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(customer.id); });

  return card;
}

/* ====================
   Drag & Drop + Trash
   ==================== */
function addDragDropListeners() {
  const cards = document.querySelectorAll('.customer-card');
  cards.forEach(card => {
    card.removeEventListener('dragstart', handleDragStart);
    card.removeEventListener('dragend', handleDragEnd);
    card.removeEventListener('dragover', handleDragOver);
    card.removeEventListener('drop', handleDropOnGrid);
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
    card.addEventListener('dragover', handleDragOver);
    card.addEventListener('drop', handleDropOnGrid);
  });
}

function handleDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', this.dataset.id);
  trashBin.classList.remove('translate-y-full');
}

function handleDragEnd(e) {
  this.classList.remove('dragging');
  draggedElement = null;
  trashBin.classList.add('translate-y-full');
  trashBin.classList.remove('drag-over');
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  if (draggedElement && draggedElement !== this) {
    const rect = this.getBoundingClientRect();
    const next = (e.clientY - rect.top) / rect.height > 0.5;
    if (next) customerGrid.insertBefore(draggedElement, this.nextSibling);
    else customerGrid.insertBefore(draggedElement, this);
  }
}

function handleDropOnGrid(e) {
  e.preventDefault();
  updateCustomerOrder();
}

function handleTrashDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; trashBin.classList.add('drag-over'); }
function handleTrashDragLeave(e) { trashBin.classList.remove('drag-over'); }

function handleTrashDrop(e) {
  e.preventDefault();
  const customerId = e.dataTransfer.getData('text/plain');
  trashBin.classList.remove('drag-over');
  const index = customers.findIndex(c => String(c.id) === String(customerId));
  if (index > -1) {
    lastDeletedCustomer = customers[index];
    trashedCustomers.push(lastDeletedCustomer);
    customers.splice(index,1);
    saveData(); renderCustomers(); updateTrashCount(); showUndo();
  }
}

function updateCustomerOrder() {
  const newOrderIds = [...customerGrid.querySelectorAll('.customer-card')].map(card => card.dataset.id);
  customers.sort((a,b) => newOrderIds.indexOf(String(a.id)) - newOrderIds.indexOf(String(b.id)));
  saveData();
}

/* ====================
   Trash UI
   ==================== */
function showUndo() {
  if (undoTimeout) clearTimeout(undoTimeout);
  undoMessage.textContent = `å·²å°‡ã€Œ${lastDeletedCustomer.name}ã€ç§»è‡³åƒåœ¾æ¡¶`;
  undoBar.classList.remove('translate-y-20','opacity-0');
  undoTimeout = setTimeout(() => { undoBar.classList.add('translate-y-20','opacity-0'); lastDeletedCustomer = null; }, 5000);
}

function handleUndo() {
  if (undoTimeout) clearTimeout(undoTimeout);
  undoBar.classList.add('translate-y-20','opacity-0');
  if (lastDeletedCustomer) {
    const idx = trashedCustomers.findIndex(c => c.id === lastDeletedCustomer.id);
    if (idx > -1) trashedCustomers.splice(idx,1);
    customers.unshift(lastDeletedCustomer);
    lastDeletedCustomer = null;
    saveData(); renderCustomers(); updateTrashCount();
  }
}

function updateTrashCount() {
  if (trashedCustomers.length > 0) {
    trashCount.textContent = trashedCustomers.length;
    trashCount.classList.remove('hidden');
  } else {
    trashCount.classList.add('hidden');
  }
}

function openTrashModal() { renderTrashList(); showModal('trash-modal'); }

function renderTrashList() {
  const list = $('#trash-list');
  list.innerHTML = '';
  if (trashedCustomers.length === 0) {
    $('#no-trash').classList.remove('hidden');
  } else {
    $('#no-trash').classList.add('hidden');
    trashedCustomers.forEach(customer => {
      const item = document.createElement('div');
      item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
      item.innerHTML = `
        <div>
          <p class="font-medium text-gray-800">${escapeHtml(customer.name)}</p>
          <p class="text-sm text-gray-500">${escapeHtml(customer.phone)}</p>
        </div>
        <div class="flex space-x-2">
          <button data-id="${customer.id}" class="restore-btn p-2 rounded-full text-green-600 hover:bg-green-100" title="å¾©åŸ"><svg class="w-5 h-5"><use href="#icon-restore"></use></svg></button>
          <button data-id="${customer.id}" class="perm-delete-btn p-2 rounded-full text-red-600 hover:bg-red-100" title="æ°¸ä¹…åˆªé™¤"><svg class="w-5 h-5"><use href="#icon-trash"></use></svg></button>
        </div>
      `;
      list.appendChild(item);
    });
    list.querySelectorAll('.restore-btn').forEach(btn => btn.addEventListener('click', restoreCustomer));
    list.querySelectorAll('.perm-delete-btn').forEach(btn => btn.addEventListener('click', deleteCustomerPermanently));
  }
}

function restoreCustomer(e) {
  const customerId = e.currentTarget.dataset.id;
  const index = trashedCustomers.findIndex(c => String(c.id) === String(customerId));
  if (index > -1) {
    const customer = trashedCustomers.splice(index,1)[0];
    customers.push(customer);
    saveData(); renderCustomers(); renderTrashList(); updateTrashCount();
  }
}

function deleteCustomerPermanently(e) {
  const customerId = e.currentTarget.dataset.id;
  const index = trashedCustomers.findIndex(c => String(c.id) === String(customerId));
  if (index > -1) {
    trashedCustomers.splice(index,1);
    saveData(); renderTrashList(); updateTrashCount();
  }
}

/* ====================
   Add / Edit form
   ==================== */
function openAddModal() {
  editingCustomerId = null;
  customerForm.reset();
  notesEditor.innerHTML = '';
  const ei = document.querySelector('#expiry-issue'); if (ei) ei.value = '';
  $('#expiry-date-display').textContent = '-';
  modalTitle.textContent = 'æ–°å¢å®¢æˆ¶';
  callLogSection.classList.add('hidden');
  showModal('customer-modal');
}

function openEditModal(customerId) {
  editingCustomerId = customerId;
  const customer = customers.find(c => String(c.id) === String(customerId));
  if (!customer) return;
  modalTitle.textContent = 'ç·¨è¼¯å®¢æˆ¶';
  $('#name').value = customer.name || '';
  $('#phone').value = customer.phone || '';
  // ç§»é™¤: $('#customer-id').value = customer.customerId || '';
  $('#dob').value = customer.dob || '';
  $('#address').value = customer.address || '';
  $('#child-name').value = customer.childName || '';
  document.querySelectorAll('.form-version').forEach(cb => cb.checked = (customer.versions || []).includes(cb.value));
  $('#start-issue-version').value = customer.startIssueVersion || '';
  $('#start-issue').value = customer.startIssue || '';
  // ç§»é™¤: $('#subscription-years').value = customer.subscriptionYears || '0';
  notesEditor.innerHTML = customer.notes || '';
  const ei = document.querySelector('#expiry-issue'); if (ei) ei.value = (customer.expiryIssue != null ? customer.expiryIssue : '');
  calculateExpiryDate();
  callLogSection.classList.remove('hidden');
  renderCallLogs(customer.callLogs);
  showModal('customer-modal');
}

function handleFormSubmit(e) {
  e.preventDefault();
  const name = $('#name').value.trim();
  const phone = $('#phone').value.trim();
  if (!name || !phone) { showAlert("ã€Œåå­—ã€å’Œã€Œé›»è©±ã€æ˜¯å¿…å¡«æ¬„ä½ã€‚"); return; }
  const duplicate = customers.find(c => c.phone === phone && String(c.id) !== String(editingCustomerId));
  if (duplicate) { showAlert(`é›»è©±è™Ÿç¢¼ ${phone} å·²å­˜åœ¨æ–¼å®¢æˆ¶ã€Œ${duplicate.name}ã€çš„è³‡æ–™ä¸­ï¼Œè«‹å‹¿é‡è¤‡ã€‚`, "è³‡æ–™é‡è¤‡"); return; }

  let existingCallLogs = [];
  if (editingCustomerId) {
    const existingCustomer = customers.find(c => String(c.id) === String(editingCustomerId));
    if (existingCustomer) existingCallLogs = existingCustomer.callLogs || [];
  }

  const customerData = {
    id: editingCustomerId ? Number(editingCustomerId) : Date.now(),
    name: name,
    phone: phone,
    childName: $('#child-name').value.trim(),
    // ç§»é™¤: customerId: $('#customer-id').value,
    dob: $('#dob').value,
    address: $('#address').value,
    versions: [...document.querySelectorAll('.form-version:checked')].map(cb => cb.value),
    startIssueVersion: $('#start-issue-version').value,
    startIssue: $('#start-issue').value,
    // ç§»é™¤: subscriptionYears: $('#subscription-years').value,
    
    // æ–°å¢ï¼šåˆ°æœŸæœŸæ•¸
    expiryIssue: (function(){ 
      const v = document.querySelector('#expiry-issue') ? document.querySelector('#expiry-issue').value : ''; 
      return (v === '' || v === null) ? null : Number(v); 
    })(),
    notes: notesEditor.innerHTML,
    callLogs: existingCallLogs
  };
  // è¨ˆç®—ä¸¦å„²å­˜æé†’ç”¨çš„æœŸæ•¸ï¼ˆä¾ç‰ˆæœ¬é è¨­æˆ–å…¨åŸŸæœˆæ•¸æ›ç®—ï¼‰
  try {
    const monthsOverride = localStorage.getItem('crm_reminder_months');
    if (customerData.expiryIssue != null && customerData.startIssueVersion) {
      customerData.remindIssue = computeReminderIssue(customerData.startIssueVersion, customerData.expiryIssue, monthsOverride);
    } else {
      customerData.remindIssue = null; // æ¸…é™¤æé†’æœŸæ•¸å¦‚æœæ²’æœ‰åˆ°æœŸæœŸæ•¸
    }
  } catch(e) { console.warn('compute remindIssue failed', e); }


  if (editingCustomerId) {
    const index = customers.findIndex(c => String(c.id) === String(editingCustomerId));
    if (index > -1) customers[index] = customerData;
  } else {
    customers.unshift(customerData);
  }

  saveData();
  renderCustomers();
  hideModal('customer-modal');
}

/* ====================
   Call log handlers
   ==================== */
function openCallLogModal() {
  callLogForm.reset();
  $('#call-log-date').value = new Date().toISOString().split('T')[0];
  showModal('call-log-modal');
}

function handleCallLogSubmit(e) {
  e.preventDefault();
  if (!editingCustomerId) return;
  const customer = customers.find(c => String(c.id) === String(editingCustomerId));
  if (!customer) return;
  if (!customer.callLogs) customer.callLogs = [];
  const newLog = { date: $('#call-log-date').value, followUp: $('#call-log-follow-up').value, notes: $('#call-log-notes').value };
  customer.callLogs.push(newLog);
  saveData(); renderCallLogs(customer.callLogs); hideModal('call-log-modal');
}

/* ====================
   Search
   ==================== */
function handleSearch() { renderCustomers(); }

/* ====================
   OCR (placeholder)
   ==================== */
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onloadend = () => {
    const base64Data = reader.result.split(',')[1];
    triggerOCR(base64Data);
  };
  reader.readAsDataURL(file);
  event.target.value = null;
}

async function triggerOCR(base64ImageData) {
  loadingOverlay.classList.remove('hidden');
  ocrStatus.classList.remove('hidden');
  ocrStatus.textContent = 'æ­£åœ¨è¾¨è­˜åœ–ç‰‡ä¸­çš„æ–‡å­—...';
  try {
    // æ¨¡æ“¬å»¶é²èˆ‡è¼¸å‡ºï¼Œè«‹ä¾éœ€æ±‚æ›¿æ›ç‚ºå¯¦éš› API å‘¼å«ï¼ˆå¾Œç«¯ä»£ç†ï¼‰
    await new Promise(r => setTimeout(r, 800));
    const text = 'ï¼ˆæ¨¡æ“¬ï¼‰åœ–ç‰‡æ–‡å­—å…§å®¹';
    notesEditor.innerHTML += (notesEditor.innerHTML ? '<br><br>' : '') + `--- åœ–ç‰‡è¾¨è­˜çµæœ ---<br>${escapeHtml(text).replace(/\n/g,'<br>')}`;
    ocrStatus.textContent = 'æ–‡å­—è¾¨è­˜æˆåŠŸï¼å·²é™„åŠ åˆ°å‚™è¨»ã€‚';
  } catch (err) {
    ocrStatus.textContent = `è¾¨è­˜å¤±æ•—: ${err.message || err}`;
    showAlert(`è¾¨è­˜å¤±æ•—: ${err.message || err}`, 'AI éŒ¯èª¤');
  } finally {
    setTimeout(()=> loadingOverlay.classList.add('hidden'), 400);
  }
}

/* ====================
   Utilities
   ==================== */
function escapeHtml(unsafe) {
  if (unsafe === null || unsafe === undefined) return '';
  return String(unsafe).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
}

/* ====================
   Export / Import (JSON)
   ==================== */
/**
 * Export customers (all fields, including childName and callLogs) to JSON file.
 */
function exportCustomersToJson() {
  // Combine customers + trashed if you want; here export only active customers.
  const data = JSON.stringify(customers, (key, value) => {
    // éæ¿¾æ‰å·²ç§»é™¤çš„æ¬„ä½ï¼Œé˜²æ­¢åŒ¯å‡ºèˆŠè³‡æ–™ä¸­å¯èƒ½å­˜åœ¨çš„ç„¡ç”¨æ¬„ä½
    if (key === 'customerId' || key === 'subscriptionYears') return undefined;
    return value;
  }, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const d = new Date();
  const filename = `customers_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.json`;
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

/**
 * Import JSON file and merge into existing customers:
 * - if phone exists (exact match) -> overwrite existing record (keep id unless incoming has id)
 * - else -> add as new record (use incoming id or Date.now())
 */
function importCustomersFromJsonFile(file) {
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const imported = JSON.parse(reader.result);
      if (!Array.isArray(imported)) throw new Error('åŒ¯å…¥æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼ˆæ‡‰ç‚º JSON é™£åˆ—ï¼‰');
      let added = 0, updated = 0;
      imported.forEach(item => {
        if (!item || !item.phone) return;
        const phone = String(item.phone).trim();
        const existIdx = customers.findIndex(c => String(c.phone).trim() === phone);

        // éæ¿¾æ‰åŒ¯å…¥è³‡æ–™ä¸­å¯èƒ½å­˜åœ¨çš„èˆŠæ¬„ä½
        const cleanItem = {...item};
        delete cleanItem.customerId;
        delete cleanItem.subscriptionYears;

        if (existIdx > -1) {
          // overwrite existing: keep existing id unless imported item has a valid id and user wants to preserve (we adopt incoming id if present)
          const keepId = cleanItem.id ? cleanItem.id : customers[existIdx].id;
          customers[existIdx] = { ...cleanItem, id: keepId };
          updated++;
        } else {
          const newId = cleanItem.id ? cleanItem.id : Date.now() + Math.floor(Math.random()*1000);
          customers.push({ ...cleanItem, id: newId });
          added++;
        }
      });
      saveData();
      renderCustomers();
      showAlert(`åŒ¯å…¥å®Œæˆï¼šæ–°å¢ ${added} ç­†ï¼Œæ›´æ–° ${updated} ç­†`, 'åŒ¯å…¥å®Œæˆ');
    } catch (err) {
      console.error('import error', err);
      showAlert(`åŒ¯å…¥å¤±æ•—ï¼š${err.message}`, 'åŒ¯å…¥éŒ¯èª¤');
    }
  };
  reader.readAsText(file);
}

/* ====================
   Event bindings
   ==================== */
loginForm.addEventListener('submit', handleLoginSubmit);
customerForm.addEventListener('submit', handleFormSubmit);
$('#add-customer-btn').addEventListener('click', openAddModal);
openTrashBtn.addEventListener('click', openTrashModal);
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => e.preventDefault());

trashBin.addEventListener('dragover', handleTrashDragOver);
trashBin.addEventListener('dragleave', handleTrashDragLeave);
trashBin.addEventListener('drop', handleTrashDrop);

undoBtn.addEventListener('click', handleUndo);

$('#card-density').addEventListener('input', (e) => {
  const v = Number(e.target.value) || 4;
  cardDensityValue.textContent = v;
  const cols = Math.max(1, Math.min(10, v));
  // set responsive classes (approximate)
  customerGrid.className = `grid grid-cols-${cols} sm:grid-cols-${cols} md:grid-cols-${cols} lg:grid-cols-${cols} gap-4`;
});

searchBar.addEventListener('input', handleSearch);

$('#ocr-camera-btn').addEventListener('click', () => $('#ocr-file-input').click());
ocrFileInput.addEventListener('change', handleImageUpload);

addCallLogBtn.addEventListener('click', () => {
  if (!editingCustomerId) { showAlert('è«‹å…ˆé¸æ“‡æˆ–ç·¨è¼¯ä¸€ä½å®¢æˆ¶ï¼Œå†æ–°å¢é€šè©±è¨˜éŒ„ã€‚'); return; }
  openCallLogModal();
});
callLogForm.addEventListener('submit', handleCallLogSubmit);

/* Export button */
exportBtn.addEventListener('click', () => {
  if (!loggedIn) { showAlert('è«‹å…ˆç™»å…¥'); return; }
  exportCustomersToJson();
});

/* Import input */
importInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (!confirm('åŒ¯å…¥å°‡èˆ‡ç¾æœ‰è³‡æ–™åˆä½µï¼ˆç›¸åŒé›»è©±å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰ã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ')) { e.target.value = null; return; }
  importCustomersFromJsonFile(file);
  e.target.value = null;
});

/* Open trash modal via button */
openTrashBtn.addEventListener('click', openTrashModal);

/* Bind expiry date calculation listener */
// ç§»é™¤ #subscription-years ç›£è½å™¨
document.querySelectorAll('#start-issue-version, #start-issue, #expiry-issue').forEach(el => {
    el.addEventListener('input', calculateExpiryDate);
});


/* Initialize PWA, Auth */
generateManifestDataUri();
registerServiceWorker();
initAuth();

/* Load data after login; do not auto-login */
if (localStorage.getItem('crm_password')) {
  // nothing, wait for user login
}

/* Expose openEditModal globally for card click handler */
window.openEditModal = openEditModal;

/* ====================
   Initial helpers: render / load
   ==================== */
function renderInitial() {
  // if already logged in (edge case), load data
  if (localStorage.getItem('crm_password') && loggedIn) loadData();
}
renderInitial();



// === Reminder calculation (by issue) ===
function computeReminderIssue(version, expiryIssue, monthsOverride) {
  // Default offsets by version (issues before)
  const DEFAULT_OFFSET = (version === '60107') ? 5 : 10; // 60108/60109 -> 10
  if (!version || !Number.isFinite(Number(expiryIssue))) return null;

  const offsetByVersion = DEFAULT_OFFSET;

  // If monthsOverride provided, convert months to issue offset for that version/customer
  const m = Number(monthsOverride);
  if (Number.isFinite(m) && m > 0 && typeof getDateFromIssue === 'function' && typeof getIssueFromDate === 'function') {
    try {
      const endIssueNum = Number(expiryIssue);
      const endDate = getDateFromIssue(version, endIssueNum); // date of the expiry issue
      const remindDate = new Date(endDate.getTime());
      remindDate.setMonth(remindDate.getMonth() - m);
      const remindIssue = getIssueFromDate(version, remindDate);
      return remindIssue;
    } catch(e) { /* fallback below */ }
  }
  // Fallback: fixed offset by version
  const endIssueNum = Number(expiryIssue);
  return endIssueNum - offsetByVersion;
}

</script>

<script>

// === Global reminder months setting ===
(function(){
  const input = document.querySelector('#global-reminder-months');
  const btn = document.querySelector('#save-reminder-months');
  if (input) {
    const saved = localStorage.getItem('crm_reminder_months');
    if (saved !== null) input.value = saved;
  }
  if (btn && !btn.__bound) {
    btn.addEventListener('click', () => {
      const v = document.querySelector('#global-reminder-months').value;
      if (v === '' || Number(v) < 0) {
        localStorage.removeItem('crm_reminder_months');
        showAlert('å·²æ¸…é™¤å…¨åŸŸæé†’è¨­å®šï¼ˆæ”¹ç”¨ç‰ˆæœ¬é è¨­æœŸæ•¸ï¼‰', 'æé†’è¨­å®š');
      } else {
        localStorage.setItem('crm_reminder_months', String(Number(v)));
        showAlert('å·²å„²å­˜å…¨åŸŸæé†’è¨­å®š', 'æé†’è¨­å®š');
      }
    });
    btn.__bound = true;
  }
})();

</script>
</body>
</html>
